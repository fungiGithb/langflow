# docker-compose.yml

services:
  langflow:
    # Imagem do Langflow (use 'latest' para versão mais recente)
    # Outras versões disponíveis em: [https://hub.docker.com/r/langflowai/langflow](https://hub.docker.com/r/langflowai/langflow)
    image: langflowai/langflow:1.6.5
    
    # Sempre fazer pull da imagem (garante versão mais recente)
    pull_policy: always
    
    # Carregar variáveis de ambiente do arquivo .env
    env_file:
      - .env
    
    # Porta de acesso: http://seu-vps:7860
    ports:
      - "7860:7860"
    
    # Langflow depende do PostgreSQL estar rodando antes
    depends_on:
      - postgres
    
    # Variáveis de ambiente que sobrescrevem o .env (se necessário)
    environment:
      - LANGFLOW_DATABASE_URL=postgresql://langflow:langflow@postgres:5432/langflow # URL de conexão com banco de dados PostgreSQL
      - LANGFLOW_CONFIG_DIR=/app/langflow #diretório onde Langflow armazena dados, logs, cache

   # CATEGORIA: CONFIGURAÇÃO BASE - environment (.env)
      - LANGFLOW_CONFIG_DIR=${LANGFLOW_CONFIG_DIR}
      - LANGFLOW_SAVE_DB_IN_CONFIG_DIR=${LANGFLOW_SAVE_DB_IN_CONFIG_DIR}
      - LANGFLOW_DATABASE_URL=${LANGFLOW_DATABASE_URL}
      - LANGFLOW_DATABASE_CONNECTION_RETRY=${LANGFLOW_DATABASE_CONNECTION_RETRY}
      - LANGFLOW_HOST=${LANGFLOW_HOST}
      - LANGFLOW_WORKERS=${LANGFLOW_WORKERS}
      - LANGFLOW_PORT=${LANGFLOW_PORT}

    # CATEGORIA: LOGS & RASTREAMENTO - environment (.env)
      - LANGFLOW_LOG_LEVEL=${LANGFLOW_LOG_LEVEL}
      - LANGFLOW_LOG_FILE=${LANGFLOW_LOG_FILE}
      - LANGFLOW_LOG_ROTATION=${LANGFLOW_LOG_ROTATION}
      - DO_NOT_TRACK=${DO_NOT_TRACK}
      - LANGFLOW_DEACTIVATE_TRACING=${LANGFLOW_DEACTIVATE_TRACING}

    # CATEGORIA: AUTENTICAÇÃO E SEGURANÇA - environment (.env)
      - LANGFLOW_SUPERUSER=${LANGFLOW_SUPERUSER}
      - LANGFLOW_SUPERUSER_PASSWORD=${LANGFLOW_SUPERUSER_PASSWORD}
      - LANGFLOW_SECRET_KEY=${LANGFLOW_SECRET_KEY}
      - LANGFLOW_ENABLE_SUPERUSER_CLI=${LANGFLOW_ENABLE_SUPERUSER_CLI}
      - LANGFLOW_AUTO_LOGIN=${LANGFLOW_AUTO_LOGIN}
      - LANGFLOW_REMOVE_API_KEYS=${LANGFLOW_REMOVE_API_KEYS}
      - LANGFLOW_STORE_ENVIRONMENT_VARIABLES=${LANGFLOW_STORE_ENVIRONMENT_VARIABLES}
      - LANGFLOW_NEW_USER_IS_ACTIVE=${LANGFLOW_NEW_USER_IS_ACTIVE}

    # CATEGORIA: INTERFACE E EXPERIÊNCIA DO USUÁRIO - environment (.env)
      - LANGFLOW_OPEN_BROWSER=${LANGFLOW_OPEN_BROWSER}
      - LANGFLOW_BACKEND_ONLY=${LANGFLOW_BACKEND_ONLY}
      - LANGFLOW_FRONTEND_PATH=${LANGFLOW_FRONTEND_PATH}
      - LANGFLOW_AUTO_SAVING=${LANGFLOW_AUTO_SAVING}
      - LANGFLOW_AUTO_SAVING_INTERVAL=${LANGFLOW_AUTO_SAVING_INTERVAL}

    # CATEGORIA: INTERFACE E EXPERIÊNCIA DO USUÁRIO - environment (.env)
      - LANGFLOW_OPEN_BROWSER=${LANGFLOW_OPEN_BROWSER}
      - LANGFLOW_BACKEND_ONLY=${LANGFLOW_BACKEND_ONLY}
      - LANGFLOW_FRONTEND_PATH=${LANGFLOW_FRONTEND_PATH}
      - LANGFLOW_AUTO_SAVING=${LANGFLOW_AUTO_SAVING}
      - LANGFLOW_AUTO_SAVING_INTERVAL=${LANGFLOW_AUTO_SAVING_INTERVAL}

    # CATEGORIA: CACHE & BANCO DE DADOS - environment (.env)
      - LANGFLOW_CACHE_TYPE=${LANGFLOW_CACHE_TYPE}
      - LANGFLOW_LANGCHAIN_CACHE=${LANGFLOW_LANGCHAIN_CACHE}
      - LANGFLOW_FALLBACK_TO_ENV_VAR=${LANGFLOW_FALLBACK_TO_ENV_VAR}

    # CATEGORIA: LIMITES E VALIDAÇÕES - environment (.env)
      - LANGFLOW_MAX_FILE_SIZE_UPLOAD=${LANGFLOW_MAX_FILE_SIZE_UPLOAD}
      - LANGFLOW_MAX_ITEMS_LENGTH=${LANGFLOW_MAX_ITEMS_LENGTH}
      - LANGFLOW_MAX_TEXT_LENGTH=${LANGFLOW_MAX_TEXT_LENGTH}
      - LANGFLOW_ERROR_ON_MISSING=${LANGFLOW_ERROR_ON_MISSING}

    # CATEGORIA: RECURSOS AVANÇADOS - environment (.env)
      - LANGFLOW_MCP_COMPOSER_ENABLED=${LANGFLOW_MCP_COMPOSER_ENABLED}
      - LANGFLOW_CELERY_ENABLED=${LANGFLOW_CELERY_ENABLED}
      - LANGFLOW_WORKER_TIMEOUT=${LANGFLOW_WORKER_TIMEOUT}
    
    # Volumes: persistir dados entre restarts
    volumes:
      - langflow-data:/app/langflow # armazena banco de dados, logs, cache, keys

    
    # Política de restart: reinicia automaticamente quando cai ou quando VPS reinicia
    restart: unless-stopped # com "unless-stopped" mantém Langflow sempre online, buscando reiniciar automaticamente os componentes que caírem (crucial para agentes 24/7)

  postgres:
    # Banco de dados PostgreSQL versão 16
    image: postgres:16
    
    # Configurações do banco de dados
    environment:
      POSTGRES_USER: langflow
      POSTGRES_PASSWORD: langflow
      POSTGRES_DB: langflow
    
    # Porta do PostgreSQL (5432 é padrão)
    # Acesso interno ao container: postgres:5432
    # Acesso externo (seu PC): localhost:5432 (opcional, para debug)
    ports:
      - "5432:5432"
    
    # Volume: persistir dados do banco entre restarts
    volumes:
      - langflow-postgres:/var/lib/postgresql/data # volume com os dados das tabelas, índices, etc

# Volumes nomeados: persistência de dados
volumes:
  langflow-postgres: # Volume do PostgreSQL: armazena banco de dados permanentemente
  langflow-data: # Volume do Langflow: armazena dados, logs, cache, configurações
